import os
import random
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# Загрузка токена из переменной окружения
TOKEN = os.environ.get("TOKEN")
if not TOKEN:
    raise ValueError("Токен не найден. Установите переменную окружения TOKEN.")

# Словарь для "Ударений" 
words = {
    "аэропорты": ["аэропОрты", "аэропортЫ"],
    "банты": ["бАнты", "бантЫ"],
    "бороду": ["бОроду", "бородУ"],
    "вероисповедание": ["вероисповЕдание", "вероисповедАние"],
    "бухгалтеров": ["бухгАлтеров", "бухгалтерОв"],
    "водопровод": ["водопровОд", "водопрОвод"],
    "газопровод": ["газопровОд", "газопрОвод"],
    "гражданство": ["граждАнство", "грАжданство"],
    "дефис": ["дефИс", "дЕфис"],
    "дешевизна": ["дешевИзна", "дешевизнА"],
    "диспансер": ["диспансЕр", "диспАнсер"],
    "договоренность": ["договорЕнность", "договОренность"],
    "документ": ["докумЕнт", "дОкумент"],
    "досуг": ["досУг", "дОсуг"],
    "еретик": ["еретИк", "Еретик"],
    "жалюзи": ["жалюзИ", "жАлюзи"],
    "значимость": ["знАчимость", "значИмость"],
    "иксы": ["Иксы", "иксЫ"],
    "каталог": ["каталОг", "кАталог"],
    "квартал": ["квартАл", "квАртал"],
    "километр": ["киломЕтр", "килОметр"],
    "конусов": ["кОнусов", "конусОв"],
    "корысть": ["корЫсть", "кОрысть"],
    "краны": ["крАны", "кранЫ"],
    "кремень": ["кремЕнь", "крЕмень"],
    "лекторов": ["лЕкторов", "лекторОв"],
    "локтя": ["лОктя", "локтЯ"],
    "лыжня": ["лыжнЯ", "лЫжня"],
    "местностей": ["мЕстностей", "местностЕй"],
    "намерение": ["намЕрение", "намерЕние"],
    "нарост": ["нарОст", "нАрост"],
    "недруг": ["нЕдруг", "недрУг"],
    "недуг": ["недУг", "нЕдуг"],
    "некролог": ["некролОг", "нЕкролог"],
    "ненависть": ["нЕнависть", "ненАвисть"],
    "нефтепровод": ["нефтепровОд", "нефтепрОвод"],
    "новостей": ["новостЕй", "нОвостей"],
    "ногтя": ["нОгтя", "ногтЯ"],
    "отзыв (о книге)": ["Отзыв", "отзЫв"],
    "отзыв (посла из страны)": ["отзЫв", "Отзыв"],
    "отозвать": ["отозвАть", "отОзвать"],
    "отрочество": ["Отрочество", "отрОчество"],
    "партер": ["партЕр", "пАртер"],
    "портфель": ["портфЕль", "пОртфель"],
    "поручни": ["пОручни", "порУчни"],
    "приданое": ["придАное", "прИданое"],
    "призыв": ["призЫв", "прИзыв"],
    "свекла": ["свЕкла", "свеклА"],
    "сироты": ["сирОты", "сИроты"],
    "созыв": ["созЫв", "сОзыв"],
    "сосредоточение": ["сосредотОчение", "сосредоточЕние"],
    "средства": ["срЕдства", "средствА"],
    "статуя": ["стАтуя", "статУя"],
    "столяр": ["столЯр", "стОляр"],
    "таможня": ["тамОжня", "тАможня"],
    "торты": ["тОрты", "тортЫ"],
    "туфля": ["тУфля", "туфлЯ"],
    "цемент": ["цемЕнт", "цЕмент"],
    "центнер": ["цЕнтнер", "центнЕр"],
    "цепочка": ["цепОчка", "цЕпочка"],
    "шарфы": ["шАрфы", "шарфЫ"],
    "шофер": ["шофЕр", "шОфер"],
    "эксперт": ["экспЕрт", "Эксперт"],
    "верна": ["вернА", "вЕрна"],
    "значимый": ["знАчимый", "значИмый"],
    "красивее": ["красИвее", "красивЕе"],
    "кухонный": ["кУхонный", "кухОнный"],
    "ловка": ["ловкА", "лОвка"],
    "мозаичный": ["мозаИчный", "мозАичный"],
    "оптовый": ["оптОвый", "Оптовый"],
    "прозорливый": ["прозорлИвый", "прозОрливый"],
    "прозорлива": ["прозорлИва", "прозОрлива"],
    "сливовый": ["слИвовый", "сливОвый"],
    "брала": ["бралА", "брАла"],
    "бралась": ["бралАсь", "брАлась"],
    "взяла": ["взялА", "взЯла"],
    "взялась": ["взялАсь", "взЯлась"],
    "влилась": ["влилАсь", "влИлась"],
    "ворвалась": ["ворвалАсь", "ворвАлась"],
    "воспринять": ["воспринЯть", "воспрИнять"],
    "восприняла": ["воспринялА", "воспрИняла"],
    "воссоздала": ["воссоздалА", "воссОздала"],
    "вручит": ["вручИт", "врУчит"],
    "гнала": ["гналА", "гнАла"],
    "гналась": ["гналАсь", "гнАлась"],
    "добрала": ["добралА", "добрАла"],
    "добралась": ["добралАсь", "добрАлась"],
    "дождалась": ["дождалАсь", "дождАлась"],
    "дозвонится": ["дозвонИтся", "дОзвонится"],
    "дозировать": ["дозИровать", "дозирОвать"],
    "ждала": ["ждалА", "ждАла"],
    "жилось": ["жилОсь", "жИлось"],
    "закупорить": ["закУпорить", "закупОрить"],
    "занять": ["занЯть", "зАнять"],
    "занял": ["зАнял", "занЯл"],
    "заняла": ["занялА", "занЯла"],
    "заняли": ["зАняли", "занЯли"],
    "заперла": ["заперлА", "зАперла"],
    "запломбировать": ["запломбировАть", "запломбИровать"],
    "защемит": ["защемИт", "защЕмит"],
    "звала": ["звалА", "звАла"],
    "звонит": ["звонИт", "звОнит"],
    "кашлянуть": ["кАшлянуть", "кашлянУть"],
    "клала": ["клАла", "клалА"],
    "клеить": ["клЕить", "клеИть"],
    "кралась": ["крАлась", "кралАсь"],
    "кровоточить": ["кровоточИть", "кровотОчить"],
    "лгала": ["лгалА", "лгАла"],
    "лила": ["лилА", "лИла"],
    "лилась": ["лилАсь", "лИлась"],
    "наврала": ["навралА", "наврАла"],
    "наделит": ["наделИт", "надЕлит"],
    "надорвалась": ["надорвалАсь", "надорвАлась"],
    "назвалась": ["назвалАсь", "нАзвалась"],
    "накренится": ["накренИтся", "накрЕнится"],
    "налила": ["налилА", "налИла"],
    "нарвала": ["нарвалА", "нарвАла"],
    "начать": ["начАть", "нАчать"],
    "начал": ["нАчал", "начАл"],
    "начала": ["началА", "нАчала"],
    "начали": ["нАчали", "начАли"],
    "обзвонит": ["обзвонИт", "обзвОнит"],
    "облегчить": ["облегчИть", "облЕгчить"],
    "облегчит": ["облегчИт", "облЕгчит"],
    "облилась": ["облилАсь", "облИлась"],
    "обнялась": ["обнялАсь", "обнЯлась"],
    "обогнала": ["обогналА", "обогнАла"],
    "ободрала": ["ободралА", "ободрАла"],
    "ободрить": ["ободрИть", "обОдрить"],
    "ободрит": ["ободрИт", "обОдрит"],
    "ободриться": ["ободрИться", "обОдриться"],
    "ободрится": ["ободрИтся", "обОдрится"],
    "обострить": ["обострИть", "обОстрить"],
    "одолжить": ["одолжИть", "одОлжить"],
    "одолжит": ["одолжИт", "одОлжит"],
    "озлобить": ["озлОбить", "озлобИть"],
    "оклеить": ["оклЕить", "оклеИть"],
    "окружить": ["окружИт", "окрУжить"],
    "опошлить": ["опОшлить", "опошлИть"],
    "осведомиться": ["освЕдомиться", "осведомИться"],
    "осведомится": ["освЕдомится", "осведомИтся"],
    "отбыла": ["отбылА", "отбЫла"],
    "отдала": ["отдалА", "отдАла"],
    "откупорить": ["откУпорить", "откупОрить"],
    "отозвала": ["отозвалА", "отозвАла"],
    "отозвалась": ["отозвалАсь", "отозвАлась"],
    "перезвонит": ["перезвонИт", "перезвОнит"],
    "перелила": ["перелилА", "перелИла"],
    "плодоносить": ["плодоносИть", "плодонОсить"],
    "пломбировать": ["пломбировАть", "пломбИровать"],
    "повторит": ["повторИт", "повтОрит"],
    "позвала": ["позвалА", "позвАла"],
    "позвонит": ["позвонИт", "позвОнит"],
    "полила": ["полилА", "полИла"],
    "положить": ["положИть", "полОжить"],
    "положил": ["положИл", "полОжил"],
    "понять": ["понЯть", "пОнять"],
    "поняла": ["понялА", "пОняла"],
    "послала": ["послАла", "послалА"],
    "прибыть": ["прибЫть", "прибЫть"],
    "прибыл": ["прИбыл", "прибЫл"],
    "прибыла": ["прибылА", "прИбыла"],
    "прибыли": ["прИбыли", "прибЫли"],
    "принять": ["принЯть", "прИнять"],
    "принял": ["прИнял", "принЯл"],
    "приняла": ["принялА", "прИняла"],
    "приняли": ["прИняли", "принЯли"],
    "рвала": ["рвалА", "рвАла"],
    "сверлит": ["сверлИт", "свЕрлит"],
    "сняла": ["снялА", "снЯла"],
    "соврала": ["совралА", "соврАла"],
    "создала": ["создалА", "создАла"],
    "сорвала": ["сорвалА", "сорвАла"],
    "сорит": ["сорИт", "сОрит"],
    "убрала": ["убралА", "убрАла"],
    "углубить": ["углубИть", "углУбить"],
    "укрепит": ["укрепИт", "укрЕпит"],
    "черпать": ["чЕрпать", "черпАть"],
    "щемит": ["щемИт", "щЕмит"],
    "щелкать": ["щЕлкать", "щелкАть"],
    "довезенный": ["довезЕнный", "дОвезенный"],
    "загнутый": ["зАгнутый", "загнУтый"],
    "занятый": ["зАнятый", "занЯтый"],
    "занята": ["занятА", "зАнята"],
    "заперты": ["зАперты", "запЕрты"],
    "заселенный": ["заселЕнный", "засЕленный"],
    "заселена": ["заселенА", "засЕлена"],
    "кормящий": ["кормЯщий", "кОрмящий"],
    "кровоточащий": ["кровоточАщий", "кровотОчащий"],
    "наживший": ["нажИвший", "нАживший"],
    "наливший": ["налИвший", "нАливший"],
    "нанявшийся": ["нанЯвшийся", "нАнявшийся"],
    "начавший": ["начАвший", "нАчавший"],
    "начатый": ["нАчатый", "начАтый"],
    "низведенный": ["низведЕнный", "нИзведенный"],
    "облегченный": ["облегчЕнный", "облЕгченный"],
    "ободренный": ["ободрЕнный", "обОдренный"],
    "обостренный": ["обострЕнный", "обОстренный"],
    "отключенный": ["отключЕнный", "отклЮченный"],
    "повторенный": ["повторЕнный", "повтОренный"],
    "поделенный": ["поделЕнный", "подЕленный"],
    "понявший": ["понЯвший", "пОнявший"],
    "принятый": ["прИнятый", "принЯтый"],
    "принята": ["принятА", "прИнята"],
    "прирученный": ["приручЕнный", "прирУченный"],
    "проживший": ["прожИвший", "прОживший"],
    "снята": ["снятА", "снЯта"],
    "согнутый": ["сОгнутый", "согнУтый"],
    "углубленный": ["углублЕнный", "углУбленный"],
    "закупорив": ["закУпорив", "закупОрив"],
    "начав": ["начАв", "нАчав"],
    "начавшись": ["начАвшись", "нАчавшись"],
    "отдав": ["отдАв", "Отдав"],
    "подняв": ["поднЯв", "пОдняв"],
    "поняв": ["понЯв", "пОняв"],
    "прибыв": ["прибЫв", "прИбыв"],
    "создав": ["создАв", "сОздав"],
    "вовремя": ["вОвремя", "воврЕмя"],
    "доверху": ["дОверху", "довЕрху"],
    "донельзя": ["донЕльзя", "дОнельзя"],
    "донизу": ["дОнизу", "донИзу"],
    "досуха": ["дОсуха", "досУха"],
    "засветло": ["зАсветло", "засвЕтло"],
    "затемно": ["зАтемно", "затЕмно"],
    "красивее": ["красИвее", "красивЕе"],
    "надолго": ["надОлго", "нАдолго"],
    "ненадолго": ["ненадОлго", "ненАдолго"]
}

#словарь для Пре-При
pre_pri_words = {
    "пр..следовать": "прЕследовать",
    "пр..нудить": "прИнудить",
    "пр..возносить": "прЕвозносить",
    "пр..мерять": "прИмерять",
    "пр..вратное (мнение)": "прЕвратное (мнение)",
    "пр..зирать": "прЕзирать",
    "пр..хоть": "прИхоть",
    "пр..вилегия": "прИвилегия",
    "пр..исполненный": "прЕисполненный",
    "пр..небрегать": "прЕнебрегать",
    "пр..обладать": "прЕобладать",
    "пр..цениться": "прИцениться",
    "пр..страстие": "прИстрастие",
    "пр..видение": "прИвидение",
    "пр..чуда": "прИчуда",
    "пр..сяга": "прИсяга",
    "пр..пятствие": "прЕпятствие",
    "пр..словутый": "прЕсловутый",
    "пр..способиться": "прИспособиться",
    "пр..тензия": "прЕтензия",
    "пр..говор": "прИговор",
    "пр..баутка": "прИбаутка",
    "пр..вередливый": "прИвередливый",
    "пр..внести": "прИвнести",
    "пр..волье": "прИволье",
    "пр..увеличить": "прЕувеличить",
    "беспр..кословно": "беспрЕкословно",
    "пр..годиться": "прИгодиться",
    "пр..льстить(ся)": "прЕльстить(ся)",
    "пр..гожий": "прИгожий",
    "пр..зидент": "прЕзидент",
    "пр..дираться": "прИдираться",
    "пр..возмочь": "прЕвозмочь",
    "пр..ключение": "прИключение",
    "пр..рогатива": "прЕрогатива",
    "пр..лежный": "прИлежный",
    "беспр..страстный": "беспрИстрастный",
    "пр..менять": "прИменять",
    "пр..оритет": "прИоритет",
    "пр..скорбный": "прИскорбный",
    "непр..менно": "непрЕменно",
    "пр..сниться": "прИсниться",
    "пр..поднести": "прЕподнести",
    "пр..страстный": "прИстрастный",
    "пр..успеть": "прЕуспеть",
    "пр..тязание": "прИтязание",
    "пр..чудливый": "прИчудливый",
    "пр..хотливый": "прИхотливый",
    "пр..знать(ся)": "прИзнать(ся)",
    "пр..целиться": "прИцелиться",
    "пр..сечь": "прЕсечь",
    "пр..людия": "прЕлюдия",
    "пр..слушиваться": "прИслушиваться",
    "пр..смотреться": "прИсмотреться",
    "пр..выкнуть": "прИвыкнуть",
    "пр..норовиться": "прИноровиться",
    "непр..миримый": "непрИмиримый",
    "пр..мета": "прИмета",
    "пр..готовить": "прИготовить",
    "пр..рост": "прИрост",
    "пр..умножить": "прИумножить",
    "непр..глядный": "непрИглядный",
    "пр..митивный": "прИмитивный",
    "пр..грешение": "прЕгрешение",
    "пр..вентивный": "прЕвентивный",
    "пр..налечь": "прИналечь"
}


# Новый словарь для "Морфологических норм" 
morphology_words = {
    "борт": "бортА",
    "вексель": "векселЯ",
    "вензель": "вензелЯ",
    "ворох": "ворохА",
    "директор": "директорА",
    "инспектор": "инспекторА",
    "катер": "катерА",
    "китель": "кителЯ",
    "кузов": "кузовА",
    "купол": "куполА",
    "окорок": "окорокА",
    "округ": "округА",
    "ордер": "ордерА",
    "паспорт": "паспортА",
    "погреб": "погребА",
    "профессор": "профессорА",
    "сторож": "сторожА",
    "тенор": "тенорА",
    "фельдшер": "фельдшерА",
    "флюгер": "флюгерА",
    "хутор": "хуторА",
    "штабель": "штабелЯ",
    "штемпель": "штемпелЯ",
    "шулер": "шулерА",
    "бухгалтер": "бухгАлтеры",
    "возраст": "вОзрасты",
    "грифель": "грИфели",
    "грунт": "грУнты",
    "диспетчер": "диспЕтчеры",
    "договор": "договОры",
    "драйвер": "дрАйверы",
    "инженер": "инженЕры",
    "конструктор": "констрУкторы",
    "лектор": "лЕкторы",
    "лифт": "лИфты",
    "плейер": "плЕйеры",
    "порт": "пОрты",
    "приговор": "приговОры",
    "принтер": "прИнтеры",
    "прожектор": "прожЕкторы",
    "редактор": "редАкторы",
    "ректор": "рЕкторы",
    "свитер": "свИтеры",
    "сектор": "сЕкторы",
    "склад": "склАды",
    "слесарь": "слЕсари",
    "снайпер": "снАйперы",
    "торт": "тОрты",
    "тренер": "трЕнеры",
    "флот": "флОты",
    "фронт": "фрОнты",
    "шофёр": "шофЁры",
    "штаб": "штАбы",
    "штурман": "штУрманы",
    "адрес (____новосёлов, ____ и телефоны)": "адресА",
    "адрес (поздравительные _____ юбилярам)": "адресЫ",
    "век (Средние__, из глубины____)": "векА",
    "век (на ____ вечные, в кои-то ____)": "вЕки",
    "год (мои __ - моё богатство)": "годА",
    "год (в ___ войны, девяностые __)": "гОды",
    "колено (__ водосточной трубы, выделывать __)": "колЕна",
    "колено (встать на ___, больные ___)": "колЕни",
    "корпус (заводские __, танковые ___)": "корпусА",
    "корпус (___ часов)": "кОрпусы",
    "крендель (выводить ногами ___)": "кренделЯ",
    "крендель (вкусные ___)": "крЕндели",
    "мех (одеваться в ___)": "мехА",
    "мех (___ с вином; кузнечные __)": "мехИ",
    "муж (___ и жёны, прочить в ___)": "мужьЯ",
    "муж (государственные ___, учёные ___)": "мужИ",
    "образ (___ святых, под ____)": "образА",
    "образ (литературные ___)": "образЫ",
    "орден (___ и медали)": "орденА",
    "орден (монашеские ___)": "орденЫ",
    "пропуск (временные __, обменять __)": "пропускА",
    "пропуск (__ занятий, __ в тексте)": "прОпуски",
    "род (___ войск)": "родА",
    "род (древние __ и племена)": "родЫ",
    "счет (оплатить ___, банковские __)": "счетА",
    "счет (свести ___)": "счЁты",
    "сын (отцы и ___)": "сыновьЯ",
    "сын (___ Отечества)": "сынЫ",
    "тон (в моде светлые __)": "тонА",
    "тон (прослушать ___ сердца)": "тОны",
    "учитель (школьные __)": "учителЯ",
    "учитель (великие ___ человечества)": "учИтели",
    "хлеб (озимые, яровые ___)": "хлебА",
    "хлеб (печь формовые __)": "хлЕбы",
    "бедуины (р.п)": "бедуИнов",
    "казахи (р.п.)": "казАхов",
    "калмыки (р.п.)": "калмЫков",
    "киргизы (р.п.)": "киргИзов",
    "монголы (р.п.)": "монгОлов",
    "семиты (р.п.)": "семИтов",
    "таджики (р.п.)": "таджИков",
    "тунгусы (р.п.)": "тунгУсов",
    "узбеки (р.п.)": "узбЕков",
    "хорваты (р.п.)": "хорвАтов",
    "якуты (р.п.)": "якУтов",
    "армяне (р.п.)": "армЯн",
    "башкиры (р.п.)": "башкИр",
    "болгары (р.п.)": "болгАр",
    "буряты (р.п.)": "бурЯт",
    "грузины (р.п.)": "грузИн",
    "лезгины (р.п.)": "лезгИн",
    "осетины (р.п.)": "осетИн",
    "румыны (р.п.)": "румЫн",
    "татары (р.п.)": "татАр",
    "турки (р.п.)": "тУрок",
    "туркмены (р.п.)": "туркмЕн",
    "цыгане (р.п.)": "цыгАн",
    "браслеты (р.п.)": "браслЕтов",
    "брелоки (р.п.)": "брелОков",
    "габариты (р.п.)": "габарИтов",
    "купоны (р.п.)": "купОнов",
    "нервы (р.п.)": "нЕрвов",
    "рельсы (р.п.)": "рЕльсов",
    "места (р.п.)": "мЕст",
    "окна (р.п.)": "Окон",
    "стёкла (р.п.)": "стЁкол",
    "абрикосы (р.п.)": "абрикОсов",
    "ананасы (р.п.)": "ананАсов",
    "апельсины (р.п.)": "апельсИнов",
    "баклажаны (р.п.)": "баклажАнов",
    "бананы (р.п.)": "банАнов",
    "георгины (р.п.)": "георгИнов",
    "гранаты (р.п.)": "гранАтов",
    "мандарины (р.п.)": "мандарИнов",
    "помидоры (р.п.)": "помидОров",
    "томаты (р.п.)": "томАтов",
    "яблоки (р.п.)": "Яблок",
    "байты (р.п.)": "бАйтов",
    "гектары (р.п.)": "гектАров",
    "граммы (р.п.)": "грАммов",
    "децибелы (р.п.)": "децибЕлов",
    "караты (р.п.)": "карАтов",
    "килограммы (р.п.)": "килогрАммов",
    "километры (р.п.)": "киломЕтров",
    "амперы (р.п.)": "ампЕр",
    "аршины (р.п.)": "аршИн",
    "биты (р.п.)": "бИт",
    "ватты (р.п.)": "вАтт",
    "вольты (р.п.)": "вОльт",
    "радианы (р.п.)": "радиАн",
    "рентгены (р.п.)": "рентгЕнов",
    "бока (р.п.)": "бокОв",
    "бронхи (р.п.)": "брОнхов",
    "ботинки (р.п.)": "ботИнок",
    "валенки (р.п.)": "вАленок",
    "джинсы (р.п.)": "джИнсов",
    "гольфы (р.п.)": "гОльфов",
    "клипсы (р.п.)": "клИпсов",
    "носки (р.п.)": "носкОв",
    "плечи (р.п.)": "плЕч",
    "погоны (р.п.)": "погОн",
    "сапоги (р.п.)": "сапОг",
    "чулки (р.п.)": "чулОк",
    "шорты (р.п.)": "шОрт",
    "бомжи (р.п.)": "бомжЕй",
    "векселя (р.п.)": "векселЕй",
    "вензеля (р.п.)": "вензелЕй",
    "госпитали (р.п.)": "госпиталЕй",
    "кабели (р.п.)": "кАбелей",
    "медведи (р.п.)": "медвЕдей",
    "гулянье (р.п.)": "гулЯний",
    "застолье (р.п.)": "застОлий",
    "кушанье (р.п.)": "кУшаний",
    "надгробье (р.п.)": "надгрОбий",
    "новоселье (р.п.)": "новосЕлий",
    "ожерелье (р.п.)": "ожерЕлий",
    "раздумье (р.п.)": "раздУмий",
    "сиденье (р.п.)": "сидЕний",
    "снадобье (р.п.)": "снАдобий",
    "соленье (р.п.)": "солЕний",
    "ущелье (р.п.)": "ущЕлий",
    "армия (р.п.)": "Армий",
    "аудитория (р.п.)": "аудитОрий",
    "бегунья (р.п.)": "бегУний",
    "гостья (р.п.)": "гОстий",
    "колдунья (р.п.)": "колдУний",
    "оладья (р.п.)": "олАдий",
    "пародия (р.п.)": "парОдий",
    "плясунья (р.п.)": "плясУний",
    "эскадрилья (р.п.)": "эскадрИлий",
    "ружьё (р.п.)": "рУжей",
    "питьё (р.п.)": "питЕй",
    "полынья (р.п.)": "полынЕй",
    "статья (р.п.)": "статЕй",
    "судья (р.п.)": "сУдей",
    "блюдце (р.п.)": "блЮдец",
    "зеркальце (р.п.)": "зЕркалец",
    "копытце (р.п.)": "копЫтец", 
    "одеяльце (р.п.)": "одеЯлец",
    "полотенце (р.п.)": "полотЕнец",
    "сердце (р.п.)": "сердЕц",
    "болотце (р.п.)": "болОтцев",
    "кружевце (р.п.)": "крУжевцев", 
    "оконце (р.п.)": "окОнцев",  
    "вафля (р.п.)": "вАфель",
    "петля (р.п.)": "пЕтель",
    "потеря (р.п.)": "потЕрь",
    "туфля (р.п.)": "тУфель",
    "баржа (р.п.)": "бАрж",
    "копна (р.п.)": "копЁн",
    "кочерга (р.п.)": "кочерЁг",
    "манжета (р.п.)": "манжЕт",
    "распря (р.п.)": "рАспрей",
    "ведомость (р.п.)": "вЕдомостЕй",
    "лопасть (р.п.)": "лопастЕй",
    "мощность (р.п.)": "мОщностей",
    "отрасль (р.п.)": "Отраслей",
    "скатерть (р.п.)": "скАтертей",
    "скорость (р.п.)": "скоростЕй",
    "четверть (р.п.)": "четвертЕй",
    "обойма (р.п.)": "обОйм",
    "пелена (р.п.)": "пелЁн",
    "серьга (р.п.)": "серЁг",
    "сирота (р.п.)": "сирОт",
    "богиня (р.п.)": "богИнь",
    "погоня (р.п.)": "погОнь",
    "тихоня (р.п.)": "тихОнь",  
    "яблоня (р.п.)": "Яблонь",
    "басня (р.п.)": "бАсен",
    "башня (р.п.)": "бАшен",
    "бойня (р.п.)": "бОен",
    "вишня (р.п.)": "вИшен",
    "двойня (р.п.)": "двОен",
    "пашня (р.п.)": "пАшен",
    "сотня (р.п.)": "сОтен",
    "спальня (р.п.)": "спАлен",
    "сплетня (р.п.)": "сплЕтен",
    "таможня (р.п.)": "тамОжен",
    "черешня (р.п.)": "черЕшен",
    "барышня (р.п.)": "бАрышень",
    "боярышня (р.п.)": "боЯрышень",
    "деревня (р.п.)": "деревЕнь",
    "кухня (р.п.)": "кУхонь",
    "будни (р.п.)": "бУдней",
    "дровни (р.п.)": "дрОвней",
    "козни (р.п.)": "кОзней",
    "пельмени (р.п.)": "пельмЕней",
    "ясли (р.п.)": "Яслей",
    "выборы (р.п.)": "вЫборов",
    "дебаты (р.п.)": "дебАтов",
    "заморозки (р.п.)": "зАморозков",
    "кулуары (р.п.)": "кулуАров",
    "мускулы (р.п.)": "мУскулов",
    "нарды (р.п.)": "нАрдов",
    "очистки (р.п.)": "очИстков",
    "соты (р.п.)": "сОтов",
    "шпроты (р.п.)": "шпрОт",
    "чипсы (р.п.)": "чИпсов",
    "зразы (р.п.)": "зрАз",
    "жабры (р.п.)": "жАбр",
    "каникулы (р.п.)": "канИкул",
    "лосины (р.п.)": "лосИн",
    "макароны (р.п.)": "макарОн",
    "невзгоды (р.п.)": "невзгОд",
    "оковы (р.п.)": "окОв",
    "сардины (р.п.)": "сардИн",
    "узы (р.п.)": "Уз"
}

# Хранилище данных пользователей
user_data = {}

# Клавиатура для главного меню (добавляем "Морфологические нормы")
main_menu_keyboard = [
    [{"text": "Ударения"}, {"text": "ПРЕ - ПРИ"}, {"text": "Морфологические нормы"}],
    [{"text": "Ошибки"}]
]

# Клавиатура для меню ошибок (добавляем "Морфологические нормы")
errors_menu_keyboard = [
    [{"text": "Ударения"}, {"text": "ПРЕ - ПРИ"}, {"text": "Морфологические нормы"}],
    [{"text": "Главное меню"}]
]

# Клавиатура для ПРЕ - ПРИ (оставляем как есть)
pre_pri_keyboard = [
    [{"text": "Е"}, {"text": "И"}],
    [{"text": "Главное меню"}]
]

# Инициализация приложения
application = Application.builder().token(TOKEN).build()

# Приветственное сообщение и главное меню
async def send_welcome(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_chat.id
    await update.message.reply_text(
        "Что будем тренировать?",
        reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True, "one_time_keyboard": True}
    )
    user_data[user_id] = {'errors': {'accents': [], 'pre_pri': [], 'morphology': []}, 'training_mode': None, 'current_word': None, 'correct_option': None}

# Обработчик текстовых сообщений
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_chat.id
    text = update.message.text.strip()

    if text == "Ударения":
        await start_training(update, context, mode="accents", use_errors=False)
    elif text == "ПРЕ - ПРИ":
        await start_training(update, context, mode="pre_pri", use_errors=False)
    elif text == "Морфологические нормы":
        await start_training(update, context, mode="morphology", use_errors=False)
    elif text == "Ошибки":
        await show_errors_menu(update, context)
    elif text == "Главное меню":
        await send_main_menu(update, context)
    elif user_id in user_data and user_data[user_id]['training_mode'] is not None:
        await check_answer(update, context)
    else:
        await update.message.reply_text(
            "Пожалуйста, используй кнопки для навигации.",
            reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
        )

# Функция для отправки главного меню
async def send_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_chat.id
    await update.message.reply_text(
        "Что будем тренировать?",
        reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True, "one_time_keyboard": True}
    )
    user_data[user_id]['training_mode'] = None

# Функция для начала тренировки
async def start_training(update: Update, context: ContextTypes.DEFAULT_TYPE, mode: str, use_errors: bool = False) -> None:
    user_id = update.effective_chat.id
    if user_id not in user_data:
        user_data[user_id] = {'errors': {'accents': [], 'pre_pri': [], 'morphology': []}, 'training_mode': None, 'current_word': None, 'correct_option': None}

    user_data[user_id]['training_mode'] = f"{mode}_errors" if use_errors else mode
    await send_question(update, context)

# Функция для отправки вопроса
async def send_question(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_chat.id
    mode = user_data[user_id]['training_mode']

    if mode == "accents":
        current_words = words
    elif mode == "accents_errors":
        current_words = {word: words[word] for word in user_data[user_id]['errors']['accents'] if word in words}
        if not current_words:
            await update.message.reply_text(
                "Все ошибки в ударениях исправлены или их нет!",
                reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
            )
            user_data[user_id]['training_mode'] = None
            return
    elif mode == "pre_pri":
        current_words = pre_pri_words
    elif mode == "pre_pri_errors":
        current_words = {word: pre_pri_words[word] for word in user_data[user_id]['errors']['pre_pri'] if word in pre_pri_words}
        if not current_words:
            await update.message.reply_text(
                "Все ошибки в ПРЕ - ПРИ исправлены или их нет!",
                reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
            )
            user_data[user_id]['training_mode'] = None
            return
    elif mode == "morphology":
        current_words = morphology_words
    elif mode == "morphology_errors":
        current_words = {word: morphology_words[word] for word in user_data[user_id]['errors']['morphology'] if word in morphology_words}
        if not current_words:
            await update.message.reply_text(
                "Все ошибки в морфологических нормах исправлены или их нет!",
                reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
            )
            user_data[user_id]['training_mode'] = None
            return
    else:
        return

    if mode in ("accents", "accents_errors"):
        word, options = random.choice(list(current_words.items()))
        correct_option = options[0]
        random.shuffle(options)
        keyboard = [[{"text": option}] for option in options]
        keyboard.append([{"text": "Главное меню"}])
        await update.message.reply_text(
            f"Выбери правильное ударение: {word}",
            reply_markup={"keyboard": keyboard, "resize_keyboard": True, "one_time_keyboard": True}
        )
    elif mode in ("pre_pri", "pre_pri_errors"):
        word, correct_answer = random.choice(list(current_words.items()))
        keyboard = pre_pri_keyboard
        await update.message.reply_text(
            f"Выбери правильную букву: {word}",
            reply_markup={"keyboard": keyboard, "resize_keyboard": True, "one_time_keyboard": True}
        )
        correct_option = "Е" if "Е" in correct_answer else "И"
    elif mode in ("morphology", "morphology_errors"):
        word, correct_answer = random.choice(list(current_words.items()))
        keyboard = [[{"text": "Главное меню"}]]
        await update.message.reply_text(
            f"Напиши правильную форму слова: {word}",
            reply_markup={"keyboard": keyboard, "resize_keyboard": True}
        )
        correct_option = correct_answer

    user_data[user_id]['current_word'] = word
    user_data[user_id]['correct_option'] = correct_option

# Функция для проверки ответа
async def check_answer(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_chat.id
    text = update.message.text.strip()

    if text == "Главное меню":
        await send_main_menu(update, context)
        return

    correct_option = user_data[user_id]['correct_option']
    word = user_data[user_id]['current_word']
    mode = user_data[user_id]['training_mode']

    if mode in ("accents", "accents_errors"):
        if text == correct_option:
            await update.message.reply_text(f"✅ Правильно! {correct_option}")
            if mode == "accents_errors" and word in user_data[user_id]['errors']['accents']:
                user_data[user_id]['errors']['accents'].remove(word)
        else:
            await update.message.reply_text(f"❌ Неправильно. Правильный ответ: {correct_option}")
            if mode == "accents" and word not in user_data[user_id]['errors']['accents']:
                user_data[user_id]['errors']['accents'].append(word)
    elif mode in ("pre_pri", "pre_pri_errors"):
        correct_answer = pre_pri_words[word]
        if text == correct_option:
            await update.message.reply_text(f"✅ Правильно! Верное написание: {correct_answer}")
            if mode == "pre_pri_errors" and word in user_data[user_id]['errors']['pre_pri']:
                user_data[user_id]['errors']['pre_pri'].remove(word)
        else:
            await update.message.reply_text(f"❌ Неправильно. Верное написание: {correct_answer}")
            if mode == "pre_pri" and word not in user_data[user_id]['errors']['pre_pri']:
                user_data[user_id]['errors']['pre_pri'].append(word)
    elif mode in ("morphology", "morphology_errors"):
        correct_answer = morphology_words[word]
        if text == correct_answer:
            await update.message.reply_text(f"✅ Верно! Правильное написание: {correct_answer}")
            if mode == "morphology_errors" and word in user_data[user_id]['errors']['morphology']:
                user_data[user_id]['errors']['morphology'].remove(word)
        else:
            await update.message.reply_text(f"❌ Ошибка. Правильное написание: {correct_answer}")
            if mode == "morphology" and word not in user_data[user_id]['errors']['morphology']:
                user_data[user_id]['errors']['morphology'].append(word)

    # Проверка на завершение режима ошибок
    if mode == "accents_errors" and not user_data[user_id]['errors']['accents']:
        await update.message.reply_text(
            "🎉 Все ошибки в ударениях исправлены!",
            reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
        )
        user_data[user_id]['training_mode'] = None
        return
    elif mode == "pre_pri_errors" and not user_data[user_id]['errors']['pre_pri']:
        await update.message.reply_text(
            "🎉 Все ошибки в ПРЕ - ПРИ исправлены!",
            reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
        )
        user_data[user_id]['training_mode'] = None
        return
    elif mode == "morphology_errors" and not user_data[user_id]['errors']['morphology']:
        await update.message.reply_text(
            "🎉 Все ошибки в морфологических нормах исправлены!",
            reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
        )
        user_data[user_id]['training_mode'] = None
        return

    await send_question(update, context)

# Функция для показа меню ошибок
async def show_errors_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_chat.id
    errors = user_data[user_id]['errors']
    if not errors['accents'] and not errors['pre_pri'] and not errors['morphology']:
        await update.message.reply_text(
            "У тебя нет ошибок, умничка!",
            reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
        )
    else:
        accents_list = "\n".join(errors['accents']) if errors['accents'] else "Нет ошибок"
        pre_pri_list = "\n".join(errors['pre_pri']) if errors['pre_pri'] else "Нет ошибок"
        morphology_list = "\n".join(errors['morphology']) if errors['morphology'] else "Нет ошибок"
        await update.message.reply_text(
            f"Твои ошибки:\nУдарения:\n{accents_list}\n\nПРЕ - ПРИ:\n{pre_pri_list}\n\nМорфологические нормы:\n{morphology_list}\n\nЧто исправлять?",
            reply_markup={"keyboard": errors_menu_keyboard, "resize_keyboard": True}
        )
        user_data[user_id]['training_mode'] = "errors"

# Обработчик выбора в меню ошибок
async def handle_errors_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_chat.id
    text = update.message.text.strip()

    if user_data[user_id]['training_mode'] == "errors":
        if text == "Ударения":
            if not user_data[user_id]['errors']['accents']:
                await update.message.reply_text(
                    "У тебя нет ошибок в ударениях!",
                    reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
                )
            else:
                await start_training(update, context, mode="accents", use_errors=True)
        elif text == "ПРЕ - ПРИ":
            if not user_data[user_id]['errors']['pre_pri']:
                await update.message.reply_text(
                    "У тебя нет ошибок в ПРЕ - ПРИ!",
                    reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
                )
            else:
                await start_training(update, context, mode="pre_pri", use_errors=True)
        elif text == "Морфологические нормы":
            if not user_data[user_id]['errors']['morphology']:
                await update.message.reply_text(
                    "У тебя нет ошибок в морфологических нормах!",
                    reply_markup={"keyboard": main_menu_keyboard, "resize_keyboard": True}
                )
            else:
                await start_training(update, context, mode="morphology", use_errors=True)
        elif text == "Главное меню":
            await send_main_menu(update, context)

# Регистрация обработчиков
application.add_handler(CommandHandler("start", send_welcome))
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, lambda update, context: handle_errors_choice(update, context) if user_data.get(update.effective_chat.id, {}).get('training_mode') == "errors" else handle_message(update, context)))

# Запуск бота
def main():
    print("Starting bot polling...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
